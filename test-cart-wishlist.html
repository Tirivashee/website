<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart & Wishlist Test - BALLYLIKE</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .test-section {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-left: 4px solid #007bff;
    }
    
    .test-section h2 {
      margin-bottom: 15px;
      color: #007bff;
    }
    
    button {
      background: #000;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      border-radius: 4px;
    }
    
    button:hover {
      background: #333;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 10px 0;
      border: 1px solid #ddd;
    }
    
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }
    
    .test-pass {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }
    
    .test-fail {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ›’ Cart & Wishlist Functionality Test</h1>
    
    <div id="loading" class="status info">
      Initializing test environment...
    </div>
    
    <div class="test-section">
      <h2>1. Manager Initialization Check</h2>
      <div id="init-results"></div>
      <button onclick="runInitTests()">Run Initialization Tests</button>
    </div>
    
    <div class="test-section">
      <h2>2. Product Loading Test</h2>
      <div id="product-results"></div>
      <button onclick="runProductTests()">Load Products from Database</button>
    </div>
    
    <div class="test-section">
      <h2>3. Cart Functionality Test</h2>
      <div id="cart-results"></div>
      <button onclick="runCartTests()">Test Cart Operations</button>
      <button onclick="clearCart()">Clear Cart</button>
    </div>
    
    <div class="test-section">
      <h2>4. Wishlist Functionality Test</h2>
      <div id="wishlist-results"></div>
      <button onclick="runWishlistTests()">Test Wishlist Operations</button>
      <button onclick="clearWishlist()">Clear Wishlist</button>
    </div>
    
    <div class="test-section">
      <h2>5. Console Output</h2>
      <div id="console-output"></div>
      <button onclick="showDebugInfo()">Show Debug Info</button>
    </div>
  </div>
  
  <!-- Load Supabase and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/wishlist.js"></script>
  <script src="js/products-loader.js"></script>
  <script src="js/notifications.js"></script>
  
  <script>
    // Override console methods to capture output
    const consoleOutput = [];
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    console.log = function(...args) {
      consoleOutput.push({type: 'log', message: args.join(' ')});
      originalLog.apply(console, args);
    };
    
    console.error = function(...args) {
      consoleOutput.push({type: 'error', message: args.join(' ')});
      originalError.apply(console, args);
    };
    
    console.warn = function(...args) {
      consoleOutput.push({type: 'warn', message: args.join(' ')});
      originalWarn.apply(console, args);
    };
    
    // Wait for initialization
    setTimeout(() => {
      const loading = document.getElementById('loading');
      if (window.cartManager && window.wishlistManager && window.productsLoader) {
        loading.className = 'status success';
        loading.textContent = 'âœ“ All managers initialized successfully!';
      } else {
        loading.className = 'status error';
        loading.textContent = 'âœ— Some managers failed to initialize. Check console for errors.';
      }
    }, 2000);
    
    function showResult(elementId, test, passed, message, data = null) {
      const container = document.getElementById(elementId);
      const result = document.createElement('div');
      result.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
      result.innerHTML = `
        <strong>${passed ? 'âœ“' : 'âœ—'} ${test}</strong><br>
        ${message}
        ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      container.appendChild(result);
    }
    
    async function runInitTests() {
      const container = document.getElementById('init-results');
      container.innerHTML = '<p>Running tests...</p>';
      
      showResult('init-results', 'Cart Manager', 
        !!window.cartManager, 
        window.cartManager ? 'CartManager is initialized' : 'CartManager not found');
      
      showResult('init-results', 'Wishlist Manager', 
        !!window.wishlistManager, 
        window.wishlistManager ? 'WishlistManager is initialized' : 'WishlistManager not found');
      
      showResult('init-results', 'Products Loader', 
        !!window.productsLoader, 
        window.productsLoader ? 'ProductsLoader is initialized' : 'ProductsLoader not found');
      
      showResult('init-results', 'Supabase Client', 
        !!window.supabaseClient, 
        window.supabaseClient ? 'Supabase client is connected' : 'Supabase client not found');
      
      showResult('init-results', 'Auth Manager', 
        !!window.authManager, 
        window.authManager ? `Auth state: ${window.authManager.isAuthenticated() ? 'Authenticated' : 'Guest'}` : 'AuthManager not found');
    }
    
    async function runProductTests() {
      const container = document.getElementById('product-results');
      container.innerHTML = '<p>Loading products...</p>';
      
      try {
        await window.productsLoader.loadProducts();
        const products = window.productsLoader.products;
        
        showResult('product-results', 'Load Products', 
          products.length > 0, 
          `Loaded ${products.length} products from database`,
          products.slice(0, 3)); // Show first 3 products
        
        if (products.length > 0) {
          const firstProduct = products[0];
          showResult('product-results', 'Product Structure', 
            firstProduct.id && firstProduct.name && firstProduct.base_price,
            'Product has required fields',
            {
              id: firstProduct.id,
              name: firstProduct.name,
              price: firstProduct.base_price,
              image: firstProduct.main_image,
              active: firstProduct.is_active
            });
        }
      } catch (error) {
        showResult('product-results', 'Load Products', false, 
          `Error loading products: ${error.message}`, error);
      }
    }
    
    async function runCartTests() {
      const container = document.getElementById('cart-results');
      container.innerHTML = '<p>Running cart tests...</p>';
      
      try {
        // Get a test product
        await window.productsLoader.loadProducts();
        const products = window.productsLoader.products;
        
        if (products.length === 0) {
          showResult('cart-results', 'Cart Test', false, 
            'No products available to test. Import products first.');
          return;
        }
        
        const testProduct = products[0];
        
        // Test adding to cart
        await window.cartManager.addItem({
          product_id: testProduct.id,
          product_name: testProduct.name,
          product_image: testProduct.main_image,
          price: testProduct.base_price,
          quantity: 1
        });
        
        showResult('cart-results', 'Add Item to Cart', 
          window.cartManager.cart.length > 0,
          `Cart now has ${window.cartManager.cart.length} item(s)`,
          window.cartManager.cart);
        
        // Test cart total
        const total = window.cartManager.getTotal();
        showResult('cart-results', 'Calculate Total', 
          total > 0,
          `Cart total: $${total.toFixed(2)}`);
        
        // Test cart count
        const count = window.cartManager.getItemCount();
        showResult('cart-results', 'Item Count', 
          count > 0,
          `Total items: ${count}`);
        
      } catch (error) {
        showResult('cart-results', 'Cart Test', false, 
          `Error: ${error.message}`, error);
      }
    }
    
    async function runWishlistTests() {
      const container = document.getElementById('wishlist-results');
      container.innerHTML = '<p>Running wishlist tests...</p>';
      
      try {
        // Get a test product
        await window.productsLoader.loadProducts();
        const products = window.productsLoader.products;
        
        if (products.length === 0) {
          showResult('wishlist-results', 'Wishlist Test', false, 
            'No products available to test. Import products first.');
          return;
        }
        
        const testProduct = products[0];
        
        // Test adding to wishlist
        await window.wishlistManager.toggleItem({
          product_id: testProduct.id,
          product_name: testProduct.name,
          product_image: testProduct.main_image,
          price: testProduct.base_price
        });
        
        showResult('wishlist-results', 'Add Item to Wishlist', 
          window.wishlistManager.wishlist.length > 0,
          `Wishlist now has ${window.wishlistManager.wishlist.length} item(s)`,
          window.wishlistManager.wishlist);
        
        // Test isInWishlist
        const isInWishlist = window.wishlistManager.isInWishlist(testProduct.id);
        showResult('wishlist-results', 'Check Item in Wishlist', 
          isInWishlist,
          `Product ${testProduct.id} is ${isInWishlist ? 'in' : 'not in'} wishlist`);
        
      } catch (error) {
        showResult('wishlist-results', 'Wishlist Test', false, 
          `Error: ${error.message}`, error);
      }
    }
    
    async function clearCart() {
      if (confirm('Clear all cart items?')) {
        window.cartManager.cart = [];
        await window.cartManager.saveToDatabase();
        showResult('cart-results', 'Clear Cart', true, 'Cart cleared successfully');
      }
    }
    
    async function clearWishlist() {
      if (confirm('Clear all wishlist items?')) {
        window.wishlistManager.wishlist = [];
        await window.wishlistManager.saveToDatabase();
        showResult('wishlist-results', 'Clear Wishlist', true, 'Wishlist cleared successfully');
      }
    }
    
    function showDebugInfo() {
      const container = document.getElementById('console-output');
      container.innerHTML = `
        <h3>System State</h3>
        <pre>${JSON.stringify({
          cart: window.cartManager?.cart || [],
          wishlist: window.wishlistManager?.wishlist || [],
          products: window.productsLoader?.products?.length || 0,
          authenticated: window.authManager?.isAuthenticated() || false,
          userId: window.authManager?.getUserId() || 'guest'
        }, null, 2)}</pre>
        
        <h3>Console Logs (Last 20)</h3>
        <pre>${consoleOutput.slice(-20).map(entry => 
          `[${entry.type.toUpperCase()}] ${entry.message}`
        ).join('\n')}</pre>
      `;
    }
  </script>
</body>
</html>
